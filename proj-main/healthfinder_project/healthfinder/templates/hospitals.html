<!DOCTYPE html>
<html>
  <head>
    <title>Live Map: Nearby Hospitals & Pharmacies</title>
    <style>
      #map {
        height: 500px;
        width: 100%;
      }
      #radiusSelect,
      #accuracySelect {
        margin: 12px 5px;
        padding: 5px;
      }
      button {
        padding: 6px 12px;
        margin: 5px;
        cursor: pointer;
      }
      .status {
        margin: 10px 0;
        padding: 8px;
        border-radius: 4px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <h1>Live Map: Nearby Hospitals & Pharmacies</h1>

    <div id="status" class="status"></div>

    <div>
      <label for="radiusSelect">Choose range (km): </label>
      <select id="radiusSelect">
        <option value="2000">2 km</option>
        <option value="5000" selected>5 km</option>
        <option value="10000">10 km</option>
        <option value="20000">20 km</option>
      </select>

      <button id="searchBtn">Search Nearby</button>
      <button id="refreshLocationBtn">Refresh Location</button>
    </div>

    <div id="map"></div>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBWevcMn1N8_jJbrTmOvIdFmmMoCBmkE4s&libraries=places&callback=initMap"
      async
      defer
      onerror="handleMapError()"
    ></script>
    
    <script>
      function handleMapError() {
        console.error("Google Maps API failed to load");
        document.getElementById("status").textContent = "Failed to load Google Maps. Please check your internet connection.";
        document.getElementById("status").className = "status error";
        document.getElementById("map").innerHTML = "<p>Map could not be loaded. Please try refreshing the page.</p>";
      }
    </script>

    <script>
      let map, userMarker, service, infowindow, currentLocation;
      let placeMarkers = [];
      let isPlacesServiceInitialized = false;

      function updateStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = "status " + type;
      }

      function initMap() {
        console.log("Google Maps API loaded");

        // Set default location (India)
        const defaultLocation = { lat: 20.5937, lng: 78.9629 };

        map = new google.maps.Map(document.getElementById("map"), {
          center: defaultLocation,
          zoom: 5,
        });


        service = new google.maps.places.PlacesService(map);
        isPlacesServiceInitialized = true;
        infowindow = new google.maps.InfoWindow();

        console.log("Places service initialized:", service);


        document.getElementById("searchBtn").onclick = searchNearby;
        document.getElementById("refreshLocationBtn").onclick = getUserLocation;


        getUserLocation();
      }

      function getUserLocation() {
        if (!navigator.geolocation) {
          updateStatus(
            "Geolocation is not supported by this browser.",
            "error"
          );
          return;
        }

        updateStatus("Getting your location...", "warning");

        const options = {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0,
        };

        navigator.geolocation.getCurrentPosition(
          (position) => {
            currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            const accuracy = position.coords.accuracy || 100;

            console.log("User location:", currentLocation);
            console.log("Accuracy:", accuracy, "meters");


            map.setCenter(currentLocation);
            map.setZoom(14);


            if (userMarker) {
              userMarker.setMap(null);
            }


            userMarker = new google.maps.Marker({
              position: currentLocation,
              map: map,
              title: `Your Location (Accuracy: ${Math.round(accuracy)}m)`,
              icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            });


            if (window.accuracyCircle) {
              window.accuracyCircle.setMap(null);
            }

            window.accuracyCircle = new google.maps.Circle({
              strokeColor: "#4285F4",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "#4285F4",
              fillOpacity: 0.15,
              map: map,
              center: currentLocation,
              radius: 2000,
            });


            updateStatus(
              `Location found! Accuracy: ${Math.round(accuracy)} meters`,
              "success"
            );
          },
          (error) => {
            console.error("Error getting location:", error);

            let errorMessage = "Error getting location: ";
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage =
                  "Location access denied. Please allow location access in your browser settings.";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage =
                  "Location information unavailable. Please try refreshing the location.";
                break;
              case error.TIMEOUT:
                errorMessage =
                  "Location request timed out. Please try refreshing the location.";
                break;
              default:
                errorMessage =
                  "Unknown error getting location. Please try refreshing the location.";
            }

            updateStatus(errorMessage, "error");
          },
          options
        );
      }

      function searchNearby() {
        if (!isPlacesServiceInitialized) {
          updateStatus("Places service not ready. Please wait...", "error");
          return;
        }

        if (!currentLocation) {
          updateStatus("Current location not set!", "error");
          return;
        }

        const radius = parseInt(document.getElementById("radiusSelect").value);


        placeMarkers.forEach((marker) => marker.setMap(null));
        placeMarkers = [];

        updateStatus(
          "Searching for nearby hospitals and pharmacies...",
          "warning"
        );


        const hospitalRequest = {
          location: currentLocation,
          radius: radius,
          type: "hospital",
        };


        const pharmacyRequest = {
          location: currentLocation,
          radius: radius,
          type: "pharmacy",
        };

        let placesFound = 0;


        service.nearbySearch(hospitalRequest, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            createPlaceMarkers(results, "hospital");
            placesFound += results.length;
          } else {
            console.log("Hospital search status:", status);
          }

          service.nearbySearch(pharmacyRequest, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              createPlaceMarkers(results, "pharmacy");
              placesFound += results.length;
            } else {
              console.log("Pharmacy search status:", status);
            }

            if (placesFound > 0) {
              updateStatus(`Found ${placesFound} nearby places`, "success");
            } else {
              updateStatus(
                "No places found. Try increasing the search radius.",
                "warning"
              );
            }
          });
        });
      }

      function createPlaceMarkers(places, type) {
        const color = type === "hospital" ? "red" : "green";
        const label = type === "hospital" ? "H" : "P";

        places.forEach((place) => {
          const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            title: `${place.name} (${type})`,
            icon: {
              url: `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
            },
          });

          placeMarkers.push(marker);

          google.maps.event.addListener(marker, "click", () => {
            const content = `
              <div>
                <strong>${place.name}</strong><br>
                ${place.vicinity || ""}<br>
                <em style="color: ${color}">${
              type.charAt(0).toUpperCase() + type.slice(1)
            }</em>
                ${place.rating ? `<br>Rating: ${place.rating}/5` : ""}
              </div>
            `;
            infowindow.setContent(content);
            infowindow.open(map, marker);
          });
        });
      }

      window.gm_authFailure = function () {
        updateStatus(
          "Google Maps API error. Please check your API key.",
          "error"
        );
      };
    </script>
  </body>
</html>